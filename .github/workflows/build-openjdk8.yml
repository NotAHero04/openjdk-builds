name: Build OpenJDK 8 for Windows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        architecture: [x86, x64]

    steps:
    - name: Checkout OpenJDK 8 source code
      uses: actions/checkout@v4
      with:
        repository: 'openjdk/jdk8u'
        ref: 'master'

    - name: Set up MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          autoconf
          make
          zip
          unzip
          cpio

    - name: Set up Boot JDK (Eclipse Temurin)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'
        architecture: x64

    - name: Configure and Build OpenJDK
      shell: cmd
      run: |
        REM Find the path to the vcvarsall.bat script.
        for /f "usebackq tokens=*" %%i in (`"%ProgramFiles(x86)%\Microsoft Visual Studio\Installer\vswhere.exe" -latest -property installationPath`) do (
          set "VS_PATH=%%i"
        )
        set "VCVARS_PATH=%VS_PATH%\VC\Auxiliary\Build\vcvarsall.bat"

        REM Determine the target architecture for Visual Studio.
        set "VS_ARCH=x64"
        if "${{ matrix.architecture }}" == "x86" (
          set "VS_ARCH=x86"
        )

        REM The JAVA_HOME env var is already a Windows path.
        set "BOOT_JDK_WIN=%JAVA_HOME%"

        REM Create a bash script with our build commands.
        echo set -e > build.sh
        echo bash ./configure --with-boot-jdk="%BOOT_JDK_WIN%" --disable-precompiled-headers --with-debug-level=release --with-milestone=github-actions >> build.sh
        echo make images >> build.sh

        REM Call vcvarsall.bat to set up the MSVC environment.
        call "%VCVARS_PATH%" %VS_ARCH%

        REM Execute the bash script. It will run in the current working directory.
        C:\msys64\usr\bin\bash.exe build.sh

    - name: Package the JDK
      shell: bash
      run: |
        cd build/windows-*/images
        zip -r openjdk-8u-windows-${{ matrix.architecture }}.zip jdk
        
    - name: Upload JDK artifact
      uses: actions/upload-artifact@v4
      with:
        name: openjdk-8u-windows-${{ matrix.architecture }}
        path: build/windows-*/images/openjdk-8u-windows-${{ matrix.architecture }}.zip
